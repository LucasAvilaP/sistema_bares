{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Sistema de Controle de Bares{% endblock %}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'core/style.css' %}">
  <style>
    .needs-ctx.disabled { pointer-events: none; opacity: .55; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="{% url 'dashboard' %}" data-ctx="1" aria-disabled="true">Controle de Bares</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNav" aria-controls="navbarNav"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
      <ul class="navbar-nav">
        {% with current=request.resolver_match.url_name rest_id=request.session.restaurante_id bar_id=request.session.bar_id %}

          <!-- Contagem (exige contexto) -->
          <li class="nav-item">
            <a class="nav-link needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'contagem' or current == 'historico-contagens' %}active{% endif %}"
               href="{% url 'contagem' %}"
               data-ctx="1"
               aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Contagem
            </a>
          </li>

          <!-- Registrar Perdas (exige contexto) -->
          <li class="nav-item">
            <a class="nav-link needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'pagina_perdas' %}active{% endif %}"
               href="{% url 'pagina_perdas' %}"
               data-ctx="1"
               aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Registrar Perdas
            </a>
          </li>

          <!-- Transfer√™ncias (exige contexto) -->
          <li class="nav-item">
            <a class="nav-link needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'transferencia-bares' or current == 'historico_transferencias' %}active{% endif %}"
               href="{% url 'transferencia-bares' %}"
               data-ctx="1"
               aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Transfer√™ncias
            </a>
          </li>

          <!-- Eventos (sempre vis√≠vel) -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {% if current == 'pagina_eventos' or current == 'editar_evento' or current == 'relatorio_eventos' %}active{% endif %}"
               href="#" id="dropdownEventos" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Eventos
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownEventos">
              <li><a class="dropdown-item" href="{% url 'pagina_eventos' %}">P√°gina de Eventos</a></li>
              <li><a class="dropdown-item" href="{% url 'relatorio_eventos' %}">Relat√≥rio de Eventos</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{% url 'exportar_consolidado_eventos_excel' %}">Exportar Consolidado (Excel)</a></li>
            </ul>
          </li>

          <!-- Requisi√ß√µes (exige contexto) -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'requisicao' or current == 'aprovar-requisicoes' or current == 'historico-requisicoes' %}active{% endif %}"
               href="#" id="dropdownRequisicoes" role="button" data-bs-toggle="dropdown" aria-expanded="false"
               data-ctx="1" aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Requisi√ß√µes
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'requisicao' %}">Nova Requisi√ß√£o</a></li>
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'aprovar-requisicoes' %}">Aprovar/Rejeitar</a></li>
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'historico-requisicoes' %}">Hist√≥rico de Requisi√ß√µes</a></li>
            </ul>
          </li>

          <!-- Hist√≥ricos (exige contexto) -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'historico-contagens' or current == 'historico-requisicoes' or current == 'historico_transferencias' %}active{% endif %}"
               href="#" id="dropdownHistoricos" role="button" data-bs-toggle="dropdown" aria-expanded="false"
               data-ctx="1" aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Hist√≥ricos
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'historico-contagens' %}">Hist√≥rico de Contagens</a></li>
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'historico-requisicoes' %}">Hist√≥rico de Requisi√ß√µes</a></li>
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'historico_transferencias' %}">Hist√≥rico de Transfer√™ncias</a></li>
              <li><a class="dropdown-item needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %}" data-ctx="1" href="{% url 'historico-entradas' %}">Hist√≥rico de Entradas</a></li>
            </ul>
          </li>

          <!-- Entrada de Estoque (exige contexto) -->
          <li class="nav-item">
            <a class="nav-link needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'entrada-mercadorias' %}active{% endif %}"
               href="{% url 'entrada-mercadorias' %}"
               data-ctx="1"
               aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Entrada Estoque
            </a>
          </li>

          <!-- Relat√≥rios (sempre vis√≠vel como p√°gina) -->
          <li class="nav-item">
            <a class="nav-link {% if current == 'relatorios' %}active{% endif %}"
               href="{% url 'relatorios' %}">Relat√≥rios</a>
          </li>

          <!-- Importa√ß√£o (exige contexto) -->
          <li class="nav-item">
            <a class="nav-link needs-ctx {% if not rest_id or not bar_id %}disabled{% endif %} {% if current == 'assistente_importacao' %}active{% endif %}"
               href="{% url 'assistente_importacao' %}"
               data-ctx="1"
               aria-disabled="{% if not rest_id or not bar_id %}true{% else %}false{% endif %}">
              Importa√ß√£o
            </a>
          </li>

          <!-- Sair -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}">Sair</a>
          </li>

        {% endwith %}
      </ul>

      {% if request.session.bar_nome %}
        <span class="navbar-text text-white">
          üßÉ <strong>{{ request.session.bar_nome }}</strong>
        </span>
      {% endif %}
    </div>
  </div>
</nav>

<div class="container">
  {% block content %}{% endblock %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function () {
    // pega valores brutos da sess√£o para saber se h√° contexto
    var restId = '{{ request.session.restaurante_id|default_if_none:"" }}';
    var barId  = '{{ request.session.bar_id|default_if_none:"" }}';
    var HAS_CTX = Boolean(restId && barId);

    document.addEventListener('click', function(e){
      var a = e.target.closest('a[data-ctx="1"]');
      if(!a) return;
      if(!HAS_CTX){
        e.preventDefault();
        var msg = document.getElementById('ctx-alert');
        if(!msg){
          msg = document.createElement('div');
          msg.id = 'ctx-alert';
          msg.className = 'alert alert-warning position-fixed top-0 start-50 translate-middle-x mt-3 shadow';
          msg.style.zIndex = 2000;
          msg.innerHTML = 'Selecione um <strong>restaurante e bar</strong> antes de acessar esta √°rea.';
          document.body.appendChild(msg);
          setTimeout(function(){ msg.remove(); }, 3000);
        }
      }
    }, true);
  })();
</script>
</body>
</html>
