{% extends 'base.html' %}
{% load custom_filters %}
{% load l10n %}
{% block content %}
<div class="container">
  <h2 class="mb-3">ğŸ› ï¸ Editar / Finalizar Evento</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success" role="alert">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="mb-3">
    <strong>{{ evento.nome }}</strong>
    {% if evento.numero_pessoas %} â€¢ ğŸ‘¥ {{ evento.numero_pessoas }}{% endif %}
    {% if evento.horas %} â€¢ â±ï¸ {{ evento.horas }} h{% endif %}
    <div class="text-muted">Data: {{ evento.data_evento|date:"d/m/Y" }} â€¢ Status: {{ evento.get_status_display }}</div>
  </div>

  <form method="post">
  {% csrf_token %}

  <!-- âœ… EDITAR DADOS GERAIS -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Horas do evento</label>
      <input
        name="horas_evento"
        type="number"
        min="0"
        step="0.5"
        class="form-control"
        value="{% if evento.horas %}{{ evento.horas|floatformat:'1' }}{% endif %}"
        placeholder="ex.: 4 ou 3,5">
      <div class="form-text">Aceita fraÃ§Ãµes (ex.: 3,5h). Use vÃ­rgula ou ponto.</div>
    </div>

    <!-- âœ… NOVO: EDITAR NÂº DE PESSOAS -->
    <div class="col-md-4">
      <label class="form-label">NÃºmero de pessoas</label>
      <input
        name="numero_pessoas_evento"
        type="number"
        min="0"
        step="1"
        class="form-control"
        value="{% if evento.numero_pessoas %}{{ evento.numero_pessoas }}{% endif %}"
        placeholder="ex.: 80">
      <div class="form-text">Deixe em branco para nÃ£o alterar.</div>
    </div>
  </div>

    <!-- BEBIDAS EXISTENTES -->
    <h5 class="mt-4">ğŸ¾ Bebidas</h5>
    <div class="table-responsive">
      <table class="table table-bordered bg-white align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:36px;" class="text-center" title="Remover item">ğŸ—‘ï¸</th>
            <th>Produto</th>
            <th style="width:160px;">Garrafas</th>
            <th style="width:160px;">Doses</th>
          </tr>
        </thead>
        <tbody>
          {% for ep in evento.produtos.all %}
          <tr data-row-type="bebida">
            <td class="text-center">
              <input type="checkbox" name="del_prod[]" value="{{ ep.id }}" class="form-check-input del-toggle" aria-label="Remover bebida">
            </td>
            <td>{{ ep.produto.nome }}</td>
            <td>
              <input name="prod_g_{{ ep.id }}" type="number" min="0" step="1" class="form-control item-input"
                     value="{% localize off %}{{ ep.garrafas }}{% endlocalize %}">
            </td>
            <td>
              <input name="prod_d_{{ ep.id }}" type="number" min="0" step="1" class="form-control item-input"
                     value="{% localize off %}{{ ep.doses }}{% endlocalize %}">
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-muted">Sem bebidas neste evento.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="form-text">Marque a caixa para remover a bebida ao salvar.</div>
    </div>

    <!-- ADICIONAR NOVA BEBIDA -->
    <div class="row g-2 align-items-end mb-4">
      <div class="col-md-6">
        <label class="form-label">Adicionar bebida</label>
        <select name="novo_produto" class="form-select">
          <option value="">Selecione</option>
          {% for p in produtos %}
            <option value="{{ p.id }}">{{ p.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Garrafas</label>
        <input name="novo_garrafas" type="number" min="0" step="1" class="form-control" value="0">
      </div>
      <div class="col-md-3">
        <label class="form-label">Doses</label>
        <input name="novo_doses" type="number" min="0" step="1" class="form-control" value="0">
      </div>
    </div>

    <!-- ALIMENTOS EXISTENTES -->
    <h5 class="mt-3">ğŸ½ï¸ Alimentos</h5>
    <div class="table-responsive">
      <table class="table table-bordered bg-white align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:36px;" class="text-center" title="Remover item">ğŸ—‘ï¸</th>
            <th>Alimento</th>
            <th style="width:220px;">Quantidade</th>
            <th>Unidade</th>
          </tr>
        </thead>
        <tbody>
          {% for ea in evento.alimentos.all %}
          <tr data-row-type="alimento">
            <td class="text-center">
              <input type="checkbox" name="del_ali[]" value="{{ ea.id }}" class="form-check-input del-toggle" aria-label="Remover alimento">
            </td>
            <td>{{ ea.alimento.nome }}</td>
            <td>
              <input name="ali_q_{{ ea.id }}" type="number" min="0" step="0.01" class="form-control item-input"
                     value="{{ ea.quantidade|as_dot:2 }}">
            </td>
            <td>{{ ea.alimento.get_unidade_display }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-muted">Sem alimentos neste evento.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="form-text">Marque a caixa para remover o alimento ao salvar.</div>
    </div>

    <!-- ADICIONAR NOVO ALIMENTO -->
    <div class="row g-2 align-items-end mb-4">
      <div class="col-md-8">
        <label class="form-label">Adicionar alimento</label>
        <select name="novo_alimento" class="form-select">
          <option value="">Selecione</option>
          {% for a in alimentos %}
            <option value="{{ a.id }}">[{{ a.codigo }}] {{ a.nome }} ({{ a.get_unidade_display }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Quantidade</label>
        <input name="novo_qtd" type="number" min="0" step="0.01" class="form-control" placeholder="ex.: 2,50">
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button type="submit" class="btn btn-outline-secondary" name="salvar">ğŸ’¾ Salvar parcial</button>
      <button type="submit" class="btn btn-primary" name="finalizar" value="1">âœ… Finalizar evento</button>
    </div>
  </form>
</div>

<!-- UX opcional: esmaece e desabilita inputs quando marcar "remover" -->
<script>
  (function () {
    const toggles = document.querySelectorAll('.del-toggle');
    toggles.forEach(function (chk) {
      const tr = chk.closest('tr');
      const inputs = tr ? tr.querySelectorAll('.item-input') : [];

      function applyState() {
        const remove = chk.checked;
        inputs.forEach(inp => inp.disabled = remove);
        if (remove) {
          tr.classList.add('table-danger', 'opacity-75');
        } else {
          tr.classList.remove('table-danger', 'opacity-75');
        }
      }

      chk.addEventListener('change', applyState);
      // estado inicial (caso browser recupere estado do form)
      applyState();
    });
  })();
</script>
{% endblock %}
