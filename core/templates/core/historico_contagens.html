{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">📅 Histórico de Contagens do Bar</h2>

    <form method="GET" class="row g-3 align-items-end mb-4">
        <div class="col-auto">
            <label for="mes" class="form-label">Mês:</label>
            <select id="mes" name="mes" class="form-select">
                {% for m in meses %}
                    <option value="{{ m }}" {% if request.GET.mes == m|stringformat:"s" %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-auto">
            <label for="ano" class="form-label">Ano:</label>
            <input type="number" id="ano" name="ano" value="{{ request.GET.ano|default:now.year }}" min="2020" max="{{ now.year }}" class="form-control">
        </div>

        <div class="col-auto">
            <button type="submit" class="btn btn-primary">🔍 Filtrar</button>
        </div>
    </form>

    {% if not agrupado %}
        <div class="alert alert-info">Nenhuma contagem registrada.</div>
    {% endif %}

    <div class="accordion" id="accordionContagens">
        {% for data, itens in agrupado.items %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                    {{ data|date:"d/m/Y" }} — {{ itens|length }} produtos
                </button>
            </h2>
            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#accordionContagens">
                <div class="accordion-body">
                    {% for item in itens %}
                    <div class="mb-3 p-3 border rounded bg-light">
                        <h5 class="mb-2"><strong>{{ item.produto.nome }}</strong></h5>
                        <p class="mb-1">🍾 Garrafas Cheias: <strong>{{ item.quantidade_garrafas_cheias }}</strong></p>
                        <p class="mb-1">🥃 Doses Restantes: <strong>{{ item.quantidade_doses_restantes }}</strong></p>
                        <p class="mb-1">👤 Usuário: {{ item.usuario.username }}</p>
                        {% if item.observacao %}
                            <p class="mb-1">📝 Observação: {{ item.observacao }}</p>
                        {% endif %}
                        <small class="text-muted">⏱️ Registrado em: {{ item.data_contagem|date:"d/m/Y H:i" }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
