{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üçæ Contagem Final do Bar ‚Äî {{ bar.nome }}</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success" role="alert">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="POST" id="form-contagem">
    {% csrf_token %}

    <div class="card shadow-sm">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th class="text-start">Produto</th>
                <th class="text-center" style="width: 220px;">Qtd Garrafas</th>
                <th class="text-center" style="width: 220px;">Qtd Doses</th>
                <th class="text-center" style="width: 120px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for linha in linhas %}
                {% with p=linha.produto %}
                <tr>
                  <td class="fw-semibold">{{ p.nome }}</td>

                  <td>
                    <div class="d-flex gap-2 justify-content-center">
                      <input
                        type="number" min="0" step="1"
                        name="garrafas_{{ p.id }}"
                        class="form-control text-center"
                        inputmode="numeric"
                      >
                      <button type="button" class="btn btn-outline-secondary px-2 incr" data-target="garrafas_{{ p.id }}">+1</button>
                    </div>
                    <div class="form-text text-center">√öltima: {{ linha.g_prev }}</div>
                  </td>

                  <td>
                    <div class="d-flex gap-2 justify-content-center">
                      <input
                        type="number" min="0" step="0.1"
                        name="doses_{{ p.id }}"
                        class="form-control text-center"
                        
                        inputmode="decimal"
                      >
                      <button type="button" class="btn btn-outline-secondary px-2 incr" data-target="doses_{{ p.id }}">+1</button>
                    </div>
                    <div class="form-text text-center">√öltima: {{ linha.d_prev }}</div>
                  </td>

                  <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger limpar" data-g="garrafas_{{ p.id }}" data-d="doses_{{ p.id }}">
                      Limpar
                    </button>
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <button type="reset" class="btn btn-outline-secondary">Limpar tudo</button>
      <button type="submit" class="btn btn-primary px-4">‚úÖ Enviar Contagem</button>
    </div>
  </form>
</div>

<style>
  .table td, .table th { vertical-align: middle; }
  .sticky-top { position: sticky; top: 0; z-index: 1; }
  .form-text { font-size: .8rem; }
</style>

<script>
  // Bot√£o +1 em cada campo
  document.querySelectorAll('.incr').forEach(btn => {
    btn.addEventListener('click', () => {
      const name = btn.getAttribute('data-target');
      const input = document.querySelector(`input[name="${name}"]`);
      if (!input) return;
      const step = parseFloat(input.getAttribute('step') || '1');
      const val = parseFloat(input.value || '0');
      input.value = (val + step).toFixed(step % 1 === 0 ? 0 : 1);
      input.dispatchEvent(new Event('change'));
    });
  });

  // Bot√£o limpar da linha
  document.querySelectorAll('.limpar').forEach(btn => {
    btn.addEventListener('click', () => {
      const g = btn.getAttribute('data-g');
      const d = btn.getAttribute('data-d');
      const ig = document.querySelector(`input[name="${g}"]`);
      const id = document.querySelector(`input[name="${d}"]`);
      if (ig) ig.value = '';
      if (id) id.value = '';
    });
  });

  // Ajuda: se tudo estiver vazio, evita POST acidental
  document.getElementById('form-contagem').addEventListener('submit', (e) => {
    const anyFilled = Array.from(document.querySelectorAll('input[type="number"]'))
      .some(i => i.value !== '');
    if (!anyFilled) {
      e.preventDefault();
      alert('Preencha ao menos uma quantidade antes de enviar.');
    }
  });
</script>
{% endblock %}
