{% extends 'base.html' %}
{% load static %}

{% block title %}Entrada de Mercadorias{% endblock %}

{% block content %}
<div class="container bg-white p-4 rounded shadow mt-4">
    <h3 class="mb-4">📥 Entrada de Mercadorias no Estoque Central</h3>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60%">Produto</th>
                        <th style="width: 30%">Quantidade</th>
                        <th style="width: 10%">Remover</th>
                    </tr>
                </thead>
                <tbody id="tabela-produtos">
                    <tr>
                        <td>
                            <select name="produto[]" class="form-select select2-produto" required>
                                <option value="">Selecione um produto</option>
                                {% for produto in produtos %}
                                    <option value="{{ produto.id }}"
                                            {% if produto.codigo %}data-codigo="{{ produto.codigo }}"{% endif %}>
                                        {{ produto.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <input type="text" name="quantidade[]" class="form-control" placeholder="Ex: 12 ou 12,5" required>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm" onclick="removerLinha(this)">✕</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-outline-secondary mb-3" onclick="adicionarLinha()">➕ Adicionar Produto</button>
        <br>
        <button type="submit" class="btn btn-success">✅ Salvar Entrada</button>
    </form>
</div>

<!-- Select2 + Estilo -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container .select2-selection--single {
        height: calc(2.375rem + 2px);
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
    }
    .select2-selection__rendered { line-height: 1.5 !important; }
    .select2-selection__arrow { height: 100% !important; }
</style>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // ----- Busca por nome OU código (em data-codigo)
    function matcherBuscaCodigo(params, data) {
        const term = (params.term || '').toLowerCase();
        if (term === '') return data;
        if (typeof data.text === 'undefined') return null;

        const text = (data.text || '').toLowerCase();
        const codigo = (data.element.getAttribute('data-codigo') || '').toLowerCase();

        return (text.indexOf(term) > -1 || codigo.indexOf(term) > -1) ? data : null;
    }

    // ----- Exibição "[CODIGO] Nome" nas opções e na seleção
    function tplComCodigo(data) {
        if (!data.id) return data.text;
        const el = data.element;
        const codigo = el.getAttribute('data-codigo') || '';
        return $(`<span>${codigo ? `[${codigo}] ` : ''}${data.text}</span>`);
    }

    // ----- Inicializador do Select2 com as opções acima
    function inicializarSelect2(context) {
        // context opcional: raiz onde procurar (document por padrão)
        (context ? $(context) : $(document)).find('.select2-produto').select2({
            placeholder: 'Selecione um produto',
            allowClear: true,
            width: '100%',
            matcher: matcherBuscaCodigo,
            templateResult: tplComCodigo,
            templateSelection: tplComCodigo
        });
    }

    $(document).ready(function () {
        inicializarSelect2();
    });

    function adicionarLinha() {
        const tabela = document.getElementById('tabela-produtos');
        const linhaOriginal = tabela.rows[0];

        // destrói select2 da linha original temporariamente para clonar “limpo”
        const selectOriginal = linhaOriginal.querySelector('.select2-produto');
        $(selectOriginal).select2('destroy');

        // clona a linha
        const novaLinha = linhaOriginal.cloneNode(true);

        // restaura select2 na linha original
        inicializarSelect2(linhaOriginal);

        // limpa campos da nova linha
        novaLinha.querySelectorAll('input').forEach(input => input.value = '');
        novaLinha.querySelectorAll('select').forEach(select => {
            select.selectedIndex = 0;
            // remove qualquer container residual do select2
            select.classList.remove('select2-hidden-accessible');
            const sibling = select.nextElementSibling;
            if (sibling && sibling.classList.contains('select2')) sibling.remove();
        });

        tabela.appendChild(novaLinha);

        // inicializa select2 só na nova linha
        inicializarSelect2(novaLinha);
    }

    function removerLinha(botao) {
        const linha = botao.closest('tr');
        const totalLinhas = document.querySelectorAll('#tabela-produtos tr').length;
        if (totalLinhas > 1) {
            linha.remove();
        } else {
            alert('Você deve ter pelo menos um produto na entrada.');
        }
    }
</script>
{% endblock %}
