{% extends 'base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">📦 Histórico de Requisições</h2>

  <form method="GET" class="row g-3 align-items-end mb-4">
    <div class="col-auto">
      <label for="mes" class="form-label">Mês:</label>
      <select id="mes" name="mes" class="form-select">
        {% for m in 1|add:0|until:13 %}
          <option value="{{ m }}" {% if request.GET.mes == m|stringformat:"s" %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label for="ano" class="form-label">Ano:</label>
      <input type="number" id="ano" name="ano" value="{{ request.GET.ano|default:now.year }}" min="2020" max="{{ now.year }}" class="form-control">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">🔍 Filtrar</button>
    </div>
  </form>

  {% if not agrupado %}
    <div class="alert alert-info">Nenhuma requisição registrada.</div>
  {% else %}
    {% if not filtro_ativo %}
      <div class="alert alert-secondary">Mostrando as 20 últimas requisições registradas.</div>
    {% endif %}
  {% endif %}

  <div class="accordion" id="accordionRequisicoes">
    {% for data, itens in agrupado.items %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
                  aria-controls="collapse{{ forloop.counter }}">
            {{ data|date:"d/m/Y" }} — {{ itens|length }} requisições
          </button>
        </h2>
        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
             aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#accordionRequisicoes">
          <div class="accordion-body">
            {% for r in itens %}
              <div class="
                mb-3 p-3 border rounded
                {% if r.status == 'APROVADA' %}border-success bg-white
                {% elif r.status == 'NEGADA' %}border-danger bg-light
                {% elif r.status == 'FALHA_ESTOQUE' %}border-warning bg-light
                {% else %}bg-light{% endif %}
              ">
                <h5 class="mb-2">
                  <strong>{{ r.produto.nome }}</strong>
                  <small class="text-muted">— {{ r.bar.nome }}</small>
                </h5>

                <p class="mb-1">📦 Quantidade: <strong>{{ r.quantidade_solicitada }}</strong></p>

                <p class="mb-1">
                  🛠️ Status:
                  {% if r.status == "APROVADA" %}
                    <span class="badge bg-success">Aprovada</span>
                  {% elif r.status == "NEGADA" %}
                    <span class="badge bg-danger">Negada</span>
                  {% elif r.status == "FALHA_ESTOQUE" %}
                    <span class="badge bg-warning text-dark">Falha no Estoque</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ r.status }}</span>
                  {% endif %}
                </p>

                {% if r.status == "NEGADA" or r.status == "FALHA_ESTOQUE" %}
                  <p class="mb-1">🧾 Motivo:
                    <em>{{ r.motivo_negativa|default:"-" }}</em>
                  </p>
                {% endif %}

                <p class="mb-1">👤 Solicitante: {{ r.usuario.username }}</p>
                <p class="mb-1">✅ Aprovador/Decisor: {{ r.usuario_aprovador.username|default:"-" }}</p>

                <small class="text-muted d-block">
                  ⏱️ Solicitado em: {{ r.data_solicitacao|date:"d/m/Y H:i" }}
                  {% if r.data_decisao %}
                    • Decidido em: {{ r.data_decisao|date:"d/m/Y H:i" }}
                  {% endif %}
                </small>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
