{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-3">üìâ Relat√≥rio de Perdas</h3>

  <!-- Filtros -->
  <form method="get" class="card card-body mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Bar</label>
        <select name="bar" class="form-select">
          <option value="">Todos</option>
          {% for b in bares %}
            <option value="{{ b.id }}" {% if bar_id|default:''|stringformat:"s" == b.id|stringformat:"s" %}selected{% endif %}>
              {{ b.nome }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Produto (nome ou c√≥digo)</label>
        <input type="text" name="produto" list="produtos-datalist" value="{{ produto_q }}" class="form-control" placeholder="Ex.: Tanqueray ou 1234">
        <datalist id="produtos-datalist">
          {% for p in produtos_lista %}
            <option value="{{ p.nome }}"></option>
            {% if p.codigo %}<option value="{{ p.codigo }}"></option>{% endif %}
          {% endfor %}
        </datalist>
      </div>

      <div class="col-md-2">
        <label class="form-label">Motivo</label>
        <select name="motivo" class="form-select">
          <option value="">Todos</option>
          {% for cod, label in MOTIVOS %}
            <option value="{{ cod }}" {% if motivo == cod %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">In√≠cio</label>
        <input type="date" name="inicio" value="{{ data_inicio|date:'Y-m-d' }}" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Fim</label>
        <input type="date" name="fim" value="{{ data_fim|date:'Y-m-d' }}" class="form-control">
      </div>

      <div class="col-12">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="pendentes" name="pendentes" value="1" {% if somente_nao_baixados %}checked{% endif %}>
          <label class="form-check-label" for="pendentes">Somente n√£o baixadas</label>
        </div>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-primary">Aplicar filtros</button>
      <a href="{% url 'relatorio_perdas' %}" class="btn btn-outline-secondary">Limpar</a>
      <a class="btn btn-outline-danger ms-auto"
         href="{% url 'exportar_relatorio_perdas_excel' %}?{{ request.GET.urlencode }}">
        ‚¨áÔ∏è Exportar Excel
      </a>
    </div>
  </form>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="border rounded p-3 bg-white">
        <div class="text-muted small">Per√≠odo</div>
        <div><strong>{{ data_inicio|date:"d/m/Y" }}</strong> a <strong>{{ data_fim|date:"d/m/Y" }}</strong></div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="border rounded p-3 bg-white">
        <div class="text-muted small">Total Garrafas Perdidas</div>
        <div class="fs-5"><strong>{{ total_garrafas|default:0 }}</strong></div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="border rounded p-3 bg-white">
        <div class="text-muted small">Total Doses Perdidas</div>
        <div class="fs-5"><strong>{{ total_doses|default:0 }}</strong></div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Consolidado por Produto -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">üì¶ Perdas por Produto</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light">
              <tr>
                <th>Produto</th>
                <th class="text-end">Garrafas</th>
                <th class="text-end">Doses</th>
              </tr>
            </thead>
            <tbody>
              {% for r in por_produto %}
                <tr>
                  <td>
                    {% if r.produto__codigo %}[{{ r.produto__codigo }}] {% endif %}{{ r.produto__nome }}
                  </td>
                  <td class="text-end">{{ r.garrafas|default:0 }}</td>
                  <td class="text-end">{{ r.doses|default:0 }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="3" class="text-center text-muted">Sem dados no per√≠odo.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Consolidado por Bar -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">üè∑Ô∏è Perdas por Bar</div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light">
              <tr>
                <th>Bar</th>
                <th class="text-end">Garrafas</th>
                <th class="text-end">Doses</th>
              </tr>
            </thead>
            <tbody>
              {% for r in por_bar %}
                <tr>
                  <td>{{ r.bar__nome }}</td>
                  <td class="text-end">{{ r.garrafas|default:0 }}</td>
                  <td class="text-end">{{ r.doses|default:0 }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="3" class="text-center text-muted">Sem dados no per√≠odo.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Detalhe -->
  <div class="card mt-3">
    <div class="card-header d-flex justify-content-between">
      <span>üßæ Detalhe das Perdas</span>
      {% if somente_nao_baixados %}<span class="badge bg-warning text-dark">Somente n√£o baixadas</span>{% endif %}
    </div>
    <div class="card-body p-0">
      <table class="table mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 120px;">Data/Hora</th>
            <th>Bar</th>
            <th>Produto</th>
            <th>Motivo</th>
            <th class="text-end">Garrafas</th>
            <th class="text-end">Doses</th>
            <th>Observa√ß√£o</th>
            <th style="width: 220px;">Baixa</th>
            <th style="width: 120px;">Usu√°rio</th>
          </tr>
        </thead>
        <tbody>
          {% for p in itens %}
            <tr>
              <td>{{ p.data_registro|date:"d/m H:i" }}</td>
              <td>{{ p.bar.nome }}</td>
              <td>{% if p.produto.codigo %}[{{ p.produto.codigo }}] {% endif %}{{ p.produto.nome }}</td>
              <td>{{ p.get_motivo_display }}</td>
              <td class="text-end">{{ p.garrafas }}</td>
              <td class="text-end">{{ p.doses }}</td>
              <td>{{ p.observacao }}</td>

              <!-- üîΩ Coluna de baixa -->
              <td>
                {% if p.baixado %}
                  <div class="d-flex flex-column gap-1">
                    <span class="badge bg-dark w-fit">Baixada</span>
                    <small class="text-muted">
                      {{ p.baixado_em|date:"d/m H:i" }} ‚Ä¢ {{ p.baixado_por|default:"-" }}
                      {% if p.baixado_obs %} ‚Ä¢ {{ p.baixado_obs }}{% endif %}
                    </small>
                    <form method="post" action="{% url 'desmarcar_perda_baixada' p.id %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-secondary">‚Ü©Ô∏è Desfazer</button>
                    </form>
                  </div>
                {% else %}
                  <form method="post" action="{% url 'marcar_perda_baixada' p.id %}" class="d-flex gap-2">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-success">‚úîÔ∏è Baixar</button>
                  </form>
                {% endif %}
              </td>

              <td>{{ p.usuario.username }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="9" class="text-center text-muted">Nenhuma perda encontrada com os filtros.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
