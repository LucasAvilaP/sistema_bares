{% extends 'base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">üìä Diferen√ßa entre Pen√∫ltima e √öltima Contagem ‚Äî {{ restaurante.nome }}</h2>


<p class="text-gray-600 mb-4">
    Este relat√≥rio compara, para cada produto, a <strong>pen√∫ltima</strong> contagem com a <strong>√∫ltima</strong> contagem, exibindo
    a diferen√ßa como <strong>√öltima ‚àí Pen√∫ltima</strong>. Valores positivos indicam aumento; negativos indicam redu√ß√£o.
</p>
<div class="d-flex justify-content-start mb-3">
  <a href="{% url 'exportar_diferenca_contagens_excel' %}"
     class="btn btn-success btn-sm d-inline-flex align-items-center">
    <span class="me-2">‚¨áÔ∏è</span>
    Exportar Excel
  </a>
</div>


{% if somatorio_total %}
    <h3 class="text-xl font-semibold mt-6 mb-2 border-b border-gray-300 pb-1 text-indigo-700">
        üîé Consolidado de Diferen√ßas por Produto
        <span class="text-sm text-gray-500">(√öltima ‚àí Pen√∫ltima)</span>
    </h3>
    <table class="table-auto w-full border-collapse border border-indigo-500 mb-6 text-sm">
        <thead class="bg-indigo-100">
            <tr>
                <th class="border px-3 py-2 text-left">Produto</th>
                <th class="border px-3 py-2 text-right">Garrafas</th>
                <th class="border px-3 py-2 text-right">Doses</th>
                <th class="border px-3 py-2 text-right">Doses (ML)</th>
            </tr>
        </thead>
        <tbody>
            {% for item in somatorio_total.values %}
                <tr>
                    <td class="border px-3 py-2">{{ item.produto.nome }}</td>
                    <td class="border px-3 py-2 text-right">{{ item.diff_garrafas|floatformat:0 }}</td>
                    <td class="border px-3 py-2 text-right">{{ item.diff_doses|floatformat:2 }}</td>
                    <td class="border px-3 py-2 text-right">{{ item.diff_doses|floatval|mul:50|floatformat:2 }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}

{% if dados_por_bar %}
    {% for bar, linhas in dados_por_bar.items %}
        <h3 class="text-lg font-semibold mt-6 mb-2 border-b border-gray-200 pb-1">
            üç∫ {{ bar }} ‚Äî {{ linhas|length }} produto(s)
        </h3>

        <table class="table-auto w-full border-collapse border border-gray-300 mb-6 text-sm">
            <thead class="bg-gray-100">
                <tr>
                    <th class="border px-3 py-2 text-left">Produto</th>

                    <!-- Pen√∫ltima primeiro -->
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>Pen√∫ltima</span>
                            <small class="text-gray-500">Garrafas</small>
                        </div>
                    </th>
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>Pen√∫ltima</span>
                            <small class="text-gray-500">Doses</small>
                        </div>
                    </th>

                    <!-- √öltima depois -->
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>√öltima</span>
                            <small class="text-gray-500">Garrafas</small>
                        </div>
                    </th>
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>√öltima</span>
                            <small class="text-gray-500">Doses</small>
                        </div>
                    </th>

                    <!-- Diferen√ßas -->
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>diferen√ßa</span>
                            <small class="text-gray-500">Garrafas</small>
                        </div>
                    </th>
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>diferen√ßa</span>
                            <small class="text-gray-500">Doses</small>
                        </div>
                    </th>
                    <th class="border px-3 py-2 text-right">
                        <div class="flex flex-col leading-tight">
                            <span>diferen√ßa</span>
                            <small class="text-gray-500">Doses (ML)</small>
                        </div>
                    </th>

                    <!-- Datas / Usu√°rios alinhados √† nova ordem -->
                    <th class="border px-3 py-2 text-left">
                        <div class="flex flex-col leading-tight">
                            <span>Data</span>
                            <small class="text-gray-500">(Pen√∫ltima)</small>
                        </div>
                    </th>
                    <th class="border px-3 py-2 text-left">
                        <div class="flex flex-col leading-tight">
                            <span>Usu√°rio</span>
                            <small class="text-gray-500">(Pen√∫ltima)</small>
                        </div>
                    </th>

                    <th class="border px-3 py-2 text-left">
                        <div class="flex flex-col leading-tight">
                            <span>Data</span>
                            <small class="text-gray-500">(√öltima)</small>
                        </div>
                    </th>
                    <th class="border px-3 py-2 text-left">
                        <div class="flex flex-col leading-tight">
                            <span>Usu√°rio</span>
                            <small class="text-gray-500">(√öltima)</small>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for linha in linhas %}
                    <tr>
                        <td class="border px-3 py-2">{{ linha.produto.nome }}</td>

                        <!-- Pen√∫ltima -->
                        <td class="border px-3 py-2 text-right">
                            {% if linha.p_g is not None %}{{ linha.p_g|floatformat:0 }}{% else %}‚Äî{% endif %}
                        </td>
                        <td class="border px-3 py-2 text-right">
                            {% if linha.p_d is not None %}{{ linha.p_d|floatformat:2 }}{% else %}‚Äî{% endif %}
                        </td>

                        <!-- √öltima -->
                        <td class="border px-3 py-2 text-right">{{ linha.u_g|floatformat:0 }}</td>
                        <td class="border px-3 py-2 text-right">{{ linha.u_d|floatformat:2 }}</td>

                        <!-- Diferen√ßas -->
                        <td class="border px-3 py-2 text-right">
                            {% if linha.diff_g is not None %}{{ linha.diff_g|floatformat:0 }}{% else %}‚Äî{% endif %}
                        </td>
                        <td class="border px-3 py-2 text-right">
                            {% if linha.diff_d is not None %}{{ linha.diff_d|floatformat:2 }}{% else %}‚Äî{% endif %}
                        </td>
                        <td class="border px-3 py-2 text-right">
                            {% if linha.diff_d is not None %}{{ linha.diff_d|floatval|mul:50|floatformat:2 }}{% else %}‚Äî{% endif %}
                        </td>

                        <!-- Datas/Usu√°rios na ordem pen√∫ltima ‚Üí √∫ltima -->
                        <td class="border px-3 py-2">
                            {% if linha.penultimo %}{{ linha.penultimo.data_contagem|date:"d/m/Y H:i" }}{% else %}‚Äî{% endif %}
                        </td>
                        <td class="border px-3 py-2">
                            {% if linha.penultimo %}{{ linha.penultimo.usuario.username }}{% else %}‚Äî{% endif %}
                        </td>

                        <td class="border px-3 py-2">{{ linha.ultimo.data_contagem|date:"d/m/Y H:i" }}</td>
                        <td class="border px-3 py-2">{{ linha.ultimo.usuario.username }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
{% else %}
    <p class="text-gray-600 mt-4">Nenhuma contagem registrada.</p>
{% endif %}
{% endblock %}
